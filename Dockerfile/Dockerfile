FROM pytorch/pytorch:2.1.0-cuda12.1-cudnn8-devel

WORKDIR /app

ENV DEBIAN_FRONTEND=noninteractive

# ğŸ§± ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    git \
    build-essential \
    cmake \
    libopenblas-dev \
    tzdata \
    libboost-all-dev \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ğŸ Python ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
RUN pip install --upgrade pip
RUN pip install --no-cache-dir \
    pytest==8.3.5 \
    matplotlib \
    torchvision==0.16.0 \
    tqdm \
    pylatexenc \
    scikit-learn==1.7.0 \
    xformers \
    debugpy \
    dotenv \
    numpy==1.26.0

# CUDA ãƒ‘ã‚¹ã®æ˜ç¤ºï¼ˆnvccãªã©ï¼‰
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=$CUDA_HOME/bin:$PATH
ENV LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

# GPUå¯¾å¿œã®Qulacsï¼ˆC++ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ï¼‹Pythonãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
RUN git clone --recursive https://github.com/qulacs/qulacs.git && \
    cd qulacs && mkdir build && cd build && \
    cmake .. -DUSE_GPU=ON -DCMAKE_BUILD_TYPE=Release && \
    make -j && \
    cmake --install . && \
    cd ../python && \
    pip install .

# ğŸ’¾ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . /app

# ğŸ èµ·å‹•ã‚³ãƒãƒ³ãƒ‰
CMD ["python", "src/train.py"]
